<html>
    <head>
        <title>Eater analaysis</title>
        <meta charset='utf-8'></meta>

        <style>
            * { margin:0; padding:0; } /* to remove the top and left whitespace */

            html, body { width:100%; height:100%; } /* just to be sure these are full screen*/

            canvas { display:block; } /* To remove the scrollbars */

        </style>
    </head>

    <body>
        
        <canvas id='cnv'></canvas>
        <script src='../../js/Demos/SmartEaters/Vector2D.js'></script>

        <script>

            let cnv = document.querySelector('#cnv');
            cnv.width = window.innerWidth;
            cnv.height = window.innerHeight;
            let ctx = cnv.getContext('2d');

            let clamp = (val, min, max) => (val >= min && val <= max) ? val : (val < min ? min : max);
        
            if (location.search.indexOf('?b=') !== -1) {
                let blob = location.search.split('?b=')[1];

                let script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = blob;
                
                script.addEventListener('load', e => {
                    run();
                });

                document.body.appendChild(script);

            }

            let food = Vector2D.rand().hadamard([cnv.width, cnv.height]);

            window.addEventListener('resize', e => {
                cnv.width = window.innerWidth;
                cnv.height = window.innerHeight;
                if (cnv.width < food.x || cnv.height < food.y)
                    food = Vector2D.rand().hadamard([cnv.width, cnv.height]);
            });

            function run() {

                let eater = Vector2D.rand().hadamard([cnv.width, cnv.height]),
                    angle = Math.random() * Math.PI * 2,
                    fs = params.food_size,
                    lookat,
                    food_dir;

                let render = () => {
                    ctx.clearRect(0, 0, cnv.width, cnv.height);

                    //draw food
                    ctx.fillStyle = 'rgb(52, 73, 94)';
                    ctx.beginPath();
                    ctx.fillRect(food.x - fs / 2, food.y - fs / 2, fs, fs);
                    ctx.fill();

                    //draw eater
                    ctx.fillStyle = 'rgb(22, 160, 133)';
                    /*
                    ctx.beginPath();
                    ctx.arc(eater.x, eater.y, params.eater_size, 0, 2 * Math.PI);
                    ctx.fill();
                    */

                    ctx.beginPath();
                    let la = lookat.times(params.eater_size).add(eater);
                    let a = la.sub(eater).angle();
                    let b = Math.PI / 1.3;
                    let u = new Vector2D(Math.cos(a + b), Math.sin(a + b));
                    let v = new Vector2D(Math.cos(a - b), Math.sin(a - b));
                    let p1 = eater.add(u.times(params.eater_size));
                    let p2 = eater.add(v.times(params.eater_size));
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(la.x, la.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.fill();

                    ctx.strokeStyle = 'black';
                    ctx.moveTo(eater.x, eater.y);
                    let fd = eater.add(food_dir.times(params.eater_size * 2));
                    ctx.lineTo(fd.x, fd.y);
                    ctx.stroke();

                };

                let tick = () => {

                    if (eater.dist(food) <= (params.eater_size + params.food_size) / 2)
                        food = Vector2D.rand().hadamard([cnv.width, cnv.height]);

                    food_dir = food.sub(eater).normalize();

                    let [turn_left, turn_right] = brain([
                            Math.cos(angle),
                            Math.sin(angle),
                            food_dir.x,
                            food_dir.y
                        ]);

                    let rot_force = clamp(turn_left - turn_right, -params.max_turn_rate, params.max_turn_rate);

                    angle += rot_force;

                    lookat = new Vector2D(Math.cos(angle), Math.sin(angle));
                    
                    eater.plus(lookat.times(params.max_speed));

                    if (params.wrap_borders) {
                        if (eater.x > cnv.width) eater.x = 0;
                        if (eater.x < 0) eater.x = cnv.width;
                        if (eater.y > cnv.height) eater.y = 0; 
                        if (eater.y < 0) eater.y = cnv.height;
                    } else {
                        if (eater.x > cnv.width) eater.x = cnv.width;
                        if (eater.x < 0) eater.x = 0;
                        if (eater.y > this.cnv.height) eater.y = cnv.height; 
                        if (eater.y < 0) eater.y = 0;
                    }

                };

                let update = () => {
                    tick();
                    render();
                    requestAnimationFrame(update);
                };  

                update();
            }
        </script>

    </body>
    
</html>